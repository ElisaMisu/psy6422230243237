---
title: "Visualizing Identity: A Study of Sexual Orientation and Religion Across England and Wales"
output: html_document
date: 
---

# Visualizing Identity: A Study of Sexual Orientation and Religion Across England and Wales

## Data

The data for this project was downloaded from the Office for National Statistics website (link in references). The original file (which can be found in the GitHub repository's data file) includes the code book and metadata on sheets on the corresponding sheets.

The data was a product of the 2021 census â€“ the sheets downloaded contained other demographic data that were collected alongside sexual orientation at the point of the census including: age, sex, employment status, smoking habits and general health.

## Research question

The decision to focus on religion and sexual orientation came after a recent discussion that ensued after sharing religious school experiences with friends and colleagues. The question being that, even if one found themselves of a sexual orientation that was deemed anathema by their church/religion, would they still identify with that religion? (which inevitably led to many other questions, outlined below under follow-up). Some churches and religious branches are now very progressive, but a religion, in its very nature, cannot be. Before scrolling through the ONS website I proposed that the data would represent this with a higher percentage of LGBTQIA+ groups identifying as not religious than the heterosexual population.

## Project script

#### Packages and importing the dataset

I developed a loop to automatically check the installation of necessary packages, ensuring the script can operate seamlessly on any system without manual adjustments. I first established the *packages* object, which includes the names of all required packages for the project script.

``` r
packages <- c("here", "readxl", "tidyverse", "shiny", "vcd", "viridis", "scales", "plotly")
```

The *for* loop iterates over each package vector element, using the variable *pkg* to hold the current package name in each iteration.

``` r
for (pkg in packages) {
  if (!require(pkg, character.only = TRUE, quietly = TRUE)) {
    install.packages(pkg)
    library(pkg, character.only = TRUE)
  }
}
```

Inside the loop, the *require()* function checks if the package named by *pkg* is installed and can be loaded. The *character.only = TRUE* argument specifies that *pkg* is a character string (the name of the package). While the *quietly = TRUE* argument suppresses warnings and other messages (to keep the console output clean as it's checking for multiple packages). If *require()* returns *FALSE* (the package is not available), *install.packages(pkg)* is called to install the package.

After installing necessary packages*, library()* is used to load all of them into the session. The *character.only = TRUE* argument again, indicates that *pkg* is a character string.

The following code then defines the path to the xlxs file using the *here() function.*

``` r
excel_file <- here("data", "sexualorientationfurtherpersonalcharacteristicsenglandandwalescensus2021.xlsx")

sexualorientationreligion <- read_excel(excel_file, 
                                        sheet = "2a", 
                                        col_types = c("skip", "text", "text", "text", "text", "text", "numeric"), 
                                        skip = 4)
```

After which sheet 2a of the file is read into the session skipping the top 4 rows and first column then defining which columns are text/numeric.

#### Preparing the data

After viewing the dataset to ensure that the correct columns/rows had been imported and all observations were there, I then began cleaning and filtering. The console was displaying the following warning.

``` r
Warning message:
Expecting numeric in G426 / R426C7: got '[c]'
```

After consulting the ONS metadata I discovered that '[c]' was in the column if the value was less than 10 so it was suppressed. To correct this I created a cleaned data frame where all cells not including [c] were retained while those including [c] were excluded. Following that I renamed the variables, see code below.

``` r
sexualorientationreligion_clean <- rename(sexualorientationreligion_clean,    
                                          c( "sexual_orientation" = "Sexual orientation", 
                                             "age" = "Age group [note 2]" , 
                                             "sex" = "Sex [note 1]", 
                                             "percentage" = "Percentage estimate of group \r\n[note 3] [note 4]"))
```

I then used the *dplyr* filtering function to create a new data frame including only the data that was necessary for the final plot.

``` r
filtered_data <- sexualorientationreligion_clean %>%
  filter(sexual_orientation != "All usual residents",
         age == "All ages 16 years and over", 
         sex == "People")  
```

## Filtered data

![](table.png){width="550"}

## Plot

```{r echo=FALSE, fig.height=10, fig.width=10, message=FALSE, warning=FALSE}
# List of packages to check and install if required

packages <- c("here", "readxl", "tidyverse", "shiny", "vcd", "viridis", "scales", "plotly")

# Loop to check and install packages if required (quietly- without warnings)

for (pkg in packages) {
  if (!require(pkg, character.only = TRUE, quietly = TRUE)) {
    install.packages(pkg)
    library(pkg, character.only = TRUE)
  }
}

# Define the path to the Excel file using the here() function
# starting with the file path

excel_file <- here("data", "sexualorientationfurtherpersonalcharacteristicsenglandandwalescensus2021.xlsx")

# Reading the data from the sheet 2a of the Excel file, skipping the first 4 rows
# and assigning appropriate column types
sexualorientationreligion <- read_excel(excel_file, 
                                        sheet = "2a", 
                                        col_types = c("skip", "text", "text", "text", "text", "text", "numeric"), 
                                        skip = 4)
# View the loaded data

View(sexualorientationreligion)

# Error message resulting from [c] in numeric column, explanation: Values under 10 have been suppressed and are displayed as "[c]".
# Solution: Remove rows with "[c]" in any column/ keep all that do not contain [c] 

sexualorientationreligion_clean <- sexualorientationreligion[!apply(sexualorientationreligion, 1, function(x) any(grepl("\\[c\\]", x))), ]

# rename the columns, leave "Religion" w/ a capital R ready for the final plot labels

sexualorientationreligion_clean <- rename(sexualorientationreligion_clean,    
                                          c( "sexual_orientation" = "Sexual orientation", 
                                             "age" = "Age group [note 2]" , 
                                             "sex" = "Sex [note 1]", 
                                             "percentage" = "Percentage estimate of group \r\n[note 3] [note 4]"))

view(sexualorientationreligion_clean)

# Filtering data using dplyr's filter 

filtered_data <- sexualorientationreligion_clean %>%
  filter(sexual_orientation != "All usual residents", #exclude all usual residents line
         age == "All ages 16 years and over", #include all ages (instead of age group breakdowns)
         sex == "People")  #just include all "people" instead of breakdown of sex

view(filtered_data)

#create plot with horizontal bars and pastel colors

p <- ggplot(filtered_data, aes(x = sexual_orientation, y = percentage / 100, fill = Religion, text = paste("Percentage:", scales::percent(percentage / 100)))) +
  geom_bar(stat = "identity", position = "stack") +
  coord_flip() +
  labs(title = "Sexual Orientation and Religious Identity",
       x = "Sexual Orientation",
       y = "Percentage") +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_brewer(palette = "Pastel1") +
  theme_light() +
  theme(legend.position = "bottom")
  

# Convert to interactive plotly object

interactive_plot <- ggplotly(p, tooltip = "text")  # specify tooltip to display percentage values

interactive_plot



```

## Future work and follow-up
